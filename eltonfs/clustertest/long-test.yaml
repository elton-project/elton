version: 1
name: elton-fs-long-test
specs:
  - type: proxmox-ve
    name: pve
    proxmox:
      address: https://elton-pve.internal.t-lab.cs.teu.ac.jp:8006/
      account:
        user: clustertest@pve
        password: waiphaefiRaiph5ing7o
      fingerprint: A6:BC:29:6C:9F:10:1C:6B:D2:90:65:A7:58:4A:15:F4:CB:86:89:10:B9:C6:8E:2E:20:1E:E0:08:CA:E1:6C:82
    address_pools:
      - start_address: 10.10.1.1
        end_address: 10.10.1.255
        cidr: 16
        gateway: 10.10.0.1
    user:
      user: root
      ssh_public_key: |
        ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCz2CNhpZjPTf9Kp/rynfb5kzVYM7Hb2rXLZhJZ1IDyHYAsxAeTuQGQqvwX8CoVWwoU+ltCt+Ce2dqWIbSJD6R4ce30CNLC30UiXhXHPopBJAFQQolbI8/e65gYuwDDs8/DAkQRtn6tFxM3I+4Z5sRURH21rNZPQDKofE1tDcfyb/R6Kvvcl+D2e7gsuPj5FXaxoS3DQsNuvPHFeEfDPy+Tu6YtmYy3rxS4YzGxaOeWjlk3LA/iRzqMsKove1lUGBmD8a0s7f4S7A+Atc7JG76YX6NDnrFX+Cxde978q0bcRD2SG4IE98/B9uzfEcPBL6TEc9uE1PsDGDNxTW1Ya0Hf yuuki@tagoken-desktop1
        ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDaUKxnmDKRVwCZE7UoZWbhOD2Lrnm61Z+fCuphdqsX9502Fk4L1yoETRg/SEOxkY2gmYtyU+9o5EDfXxFEVmMD0DpoWiXFvvyXz+tFT6lHPRMs7jI5dnWoVD1Vq03EKm6OgPNd9TF4qFK/vLi0L3vsSoRP9C6oQQfXt/VwMPbKPqLXp2yOq9RZPGShIH8D9osGE1iF00SNllxNENmFHUxW/gpux8u8mGR0IFJ5o7F2+oZiLgosdyiVQR7lPgSNJv8WE7+XBo8Pbih8cmElR9D+SMoEip3/cOLOncR3laX6MCfwyw0yNOEL3vXPEY2OEUExg68Cb/n+DTSnnNsmVa31 yuuki@gate-worker
    vms:
      vm:
        template: template-ubuntu-19.04-ltp
        pool: clustertest
        nodes: 1
        processors: 4
        memory_size: 4096
        storage_size: 10
        scripts:
          before:
            type: remote-shell
            commands:
              # Install kernel module.
              - 'git clone --depth=1 https://gitlab.t-lab.cs.teu.ac.jp/yuuki/elton.git'
              - 'cd elton && make build'
              - 'cd elton && make install'
              - 'cd elton/eltonfs && make mount'
              # Install ltp
              - 'until apt install -y build-essential automake; do sleep 1; done'
              - '[ -d ltp-full-20190517 ] || curl -SsL https://github.com/linux-test-project/ltp/releases/download/20190517/ltp-full-20190517.tar.xz |xz -d |tar xv'
              - 'ln -s ltp-full-20190517 ltp'
              - 'cd ltp && make autotools'
              - 'cd ltp && ./configure'
              - 'cd ltp && make -j`nproc`'
              - 'cd ltp && make install'
          main:
            type: remote-shell
            commands:
              - 'chmod 1777 /mnt'
              # Skip test cases for 16-bit version syscalls.
              - grep -Rh _16 /opt/ltp/runtest |awk '{print $1}' >/skip
              # Skip a test case to prevent kernel hangs.
              # TODO: fix bugs that kernel hangs when execute the execveat03.
              - echo execveat03 >>/skip
              # Skip a test case.
              # This test case would be fail, but it perhaps is not file system bug.
              - echo msgstress03 >>/skip
              # Run the LTP.
              # Options:
              #   -t  -- running time
              #   -i  -- additional background load on I/O bus
              #   -m  -- additional background load on main memotry
              #   -D  -- additional background load on secondary storage
              #   -p  -- human readable format logfiles.
              #   -S  -- Skip tests specified in file.
              #   -d  -- temporary directory
              #   -l  -- log file
              #   -o  -- output file
              # Note: runltp command will return exit code 1.  We should ignore it.
              - '/opt/ltp/runltp -t 10m -i 2 -m 4,50,10240,1 -D 4,100,80000,1 -p -S /skip -d /mnt/tmp -l /logfile -o /outfile || :'
              # Show result
              - 'find /mnt -ls'
              - 'df -h'
              - 'free -h'
              - 'mount --all'
          after:
            type: remote-shell
            commands:
              # Show logs
              - 'cat /outfile || :'
              - 'cat /logfile || :'
